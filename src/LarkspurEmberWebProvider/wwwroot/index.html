<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Larkspur</title>
    <style type="text/css">
        body {
            font-family: arial, sans-serif;
            font-size: 10px;
            background: #004dca;
            color: #e7f5ff;
        }

        h1 {
            font-size: 4em;
            letter-spacing: -3px;
        }

        h2 {
            font-size: 2em;
        }

        .tree-state-list {
            padding: 0;
            margin: 0;
            width: 100%;
            font-size: 2em;
        }

        .tree-state-list li {
            padding: 0;
            margin: 0;
            width: 100%;
            display: grid;
            grid-template-columns: 2fr 1fr 0.5fr;
            grid-gap: 2em;
        }

        .tree-path {
            font-weight: normal;
        }

        .tree-value {
            font-weight: bold;
            color: #0bbc0b;
        }

        .tree-option {
            cursor: pointer;
            text-decoration: underline;
            padding: 0 0.3em;
        }

        .tree-option--non-writable {
            cursor: not-allowed;
            text-decoration: line-through;
            padding: 0 0.3em;
        }

        .tree-state-matrix {
            padding: 0;
            margin: 0;
            width: 100%;
            font-size: 2em;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 0.2em;
        }

        .tree-state-matrix div {
            padding: 0;
            margin: 0;
            display: grid;
            justify-content: center;
            align-content: center;
        }

        .tree-state-matrix .matrix-signal {
            justify-self: center;
            width: 30px;
            height: 30px;
            text-align: center;
            vertical-align: middle;
            justify-content: center;
            border: 1px solid white;
            border-radius: 50%;
        }

        .tree-state-matrix .matrix-label--source {
            text-align: left;
            justify-content: left;
        }

        .tree-state-matrix .matrix-label--target {
            text-align: center;
            justify-content: center;
        }

        .matrix-signal--connected {
            background: white;
            color: black;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>Socket status <span id="socketStatus"></span></h1>

    <h2>Initial state</h2>
    <div class="row">
        <ul id="treeInitialList" class="tree-state-list"></ul>
    </div>

    <h2>Initial state matrix</h2>
    <div class="row">
        <div id="matrixInitialTable">

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@3.1.3/dist/browser/signalr.min.js"></script>

<script type="text/javascript">
    "use strict";

    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/larkspurHub")
        .withAutomaticReconnect()
        .build();

    setSocketConnectionFeedback("Disconnected");

    connection.on("InitialEmberTree", (tree) => {
        console.log(tree);
        let arr = Object.entries(tree).sort();
        for (let i = 0; i < arr.length; i++) {
            //console.log(`Item: '${arr[i][0]}' Value: '${arr[i][1].value}' TypeOf: '${typeof(arr[i][1].value)}'`);
            let li = buildTreeListItem(arr[i][0], arr[i][1], "id_");
            li.id = "id_row_" + treeIdFromStringPath(arr[i][0]);
            document.getElementById("treeInitialList").prepend(li);
        }
    });

    connection.on("ChangesInEmberTree", (path, data) => {
        console.log(path, data);
        let li = buildTreeListItem(path, data, "idrow_");
        document.getElementById("id_" + treeIdFromStringPath(path)).innerHTML = data.value;
    });

    connection.on("InitialEmberTreeMatrix", (matrices) => {
        console.log(matrices);
        let arr = Object.entries(matrices).sort();
        for (let i = 0; i < arr.length; i++) {
            let frag = buildMatrixView(arr[i][0], arr[i][1]);
            document.getElementById("matrixInitialTable").append(frag);
        }
    });

    connection.on("ChangesInEmberTreeMatrix", (path, target) => {
        console.log(path, target);

        // Remove all connected sources from target
        var targetBoxes = document.querySelectorAll(".matrix-signal_" + target.index + "_" + treeIdFromStringPath(path));
        targetBoxes.forEach(function(item) {
            item.classList.remove("matrix-signal--connected");
        });

        // Connect target with source
        for (let i = 0; i < target.connectedSources.length; i++) {
            document.getElementById("id_signal_" + target.connectedSources[i] + "_" + target.index + "_" + treeIdFromStringPath(path)).classList.add("matrix-signal--connected");
        }
    });

    connection.start()
        .then(function () {
            setSocketConnectionFeedback(connection.connectionState);
            connection.invoke("RequestInitialState").catch((err) => {
                return console.error("Could not request initial state", err);
            });
        })
        .catch(function (err) {
            setSocketConnectionFeedback("Error " + err.toString());
            return console.error(err.toString());
        });

    connection.onclose(function() {
        console.log("connection onclose");
        setSocketConnectionFeedback(connection.connectionState);
    });

    connection.onreconnecting(function(error) {
        console.log("connection onreconnecting", error);
        setSocketConnectionFeedback(connection.connectionState);
    });

    connection.onreconnected(function() {
        console.log("connection onreconnected");
        setSocketConnectionFeedback(connection.connectionState);

        connection.invoke("RequestInitialState").catch((err) => {
            return console.error("Could not request initial state", err);
        });
    });

    function setSocketConnectionFeedback(message) {
        document.getElementById("socketStatus").textContent = message;
    }

    function buildMatrixView(path, matrix) {
        let frag = document.createDocumentFragment();

        let box = document.createElement("DIV");
        box.classList.add("tree-state-matrix");
        box.id = treeIdFromStringPath(path);

        if (matrix.hasOwnProperty("sources") && matrix.hasOwnProperty("targets")) {

            // Add matrix label
            let lbl = document.createElement("DIV");
            lbl.classList.add("matrix-title");
            lbl.style.gridColumn = `1 / span ${matrix.targets.length + 1}`;
            lbl.textContent = path;
            box.append(lbl);

            // Add top left corner
            let div = document.createElement("DIV");
            div.classList.add("matrix-origo");
            box.append(div);

            // Add matrix
            let targets = matrix.targets;
            for (let i = 0; i < targets.length; i++) {
                // Target label
                let div = document.createElement("DIV");
                // div.id = "id_target_" + targets[i].index;
                div.textContent = targets[i].name;
                div.classList.add("matrix-label--target");
                box.append(div);
            }

            let sources = matrix.sources;
            for (let i = 0; i < sources.length; i++) {
                // Source label
                let div = document.createElement("DIV");
                // div.id = "id_source_" + sources[i].index;
                div.textContent = sources[i].name;
                div.classList.add("matrix-label--source");
                box.append(div);

                // Signals
                for (let y = 0; y < targets.length; y++) {
                    let signal = document.createElement("DIV");
                    signal.classList.add("matrix-signal");
                    signal.classList.add("matrix-signal_" + targets[y].index + "_" + treeIdFromStringPath(path));
                    signal.id = "id_signal_" + sources[i].index + "_" + targets[y].index + "_" + treeIdFromStringPath(path);

                    // Actually connect
                    if (targets[y].connectedSources.length !== 0) {
                        targets[y].connectedSources.forEach((item) => {
                            if (item === sources[i].index) {
                                signal.classList.add("matrix-signal--connected");
                            }
                        });
                    }

                    box.append(signal);
                }
            }
        }

        box.style.gridTemplateColumns = `2fr repeat(${matrix.targets.length}, 1fr)`;
        frag.append(box);
        return frag;
    }

    function buildTreeListItem(path, data, idPrefix) {
        let li = document.createElement("LI");

        // Add path information
        let dv1 = document.createElement("DIV");
        dv1.classList.add("tree-path");
        dv1.textContent = path;
        li.appendChild(dv1);

        // Add actual values
        let dv2 = document.createElement("DIV");
        dv2.classList.add("tree-value");
        dv2.textContent = data.value;
        dv2.id = idPrefix + treeIdFromStringPath(path);
        dv2.contentEditable = "true";
        dv2.addEventListener("input", function(data) {
            console.log("Content editable: ", data.srcElement.textContent);
        }, false);
        li.appendChild(dv2);

        // Add edit button
        if (data.isWritable) {
            let dvo = document.createElement("DIV");
            dvo.classList.add("tree-options");

            if (typeof (data.value) === "string") {
                let dvlink = document.createElement("A");
                dvlink.classList.add("tree-option");
                dvlink.textContent = "change";
                let ofn = "emberChangeString(this,'"+path+"','"+data.value+"','"+data.numericPath+"')";
                dvlink.setAttribute("onclick", ofn);
                dvo.append(dvlink);
            }
            if (typeof (data.value) === "number") {
                let dvlink = document.createElement("A");
                dvlink.classList.add("tree-option");
                dvlink.textContent = "change";
                let ofn = "emberChangeNumber(this,'"+path+"','"+data.value+"','"+data.numericPath+"')";
                dvlink.setAttribute("onclick", ofn);
                dvo.append(dvlink);
            }
            if (typeof (data.value) === "boolean") {
                let linktrue = document.createElement("A");
                linktrue.classList.add("tree-option");
                linktrue.textContent = "true";
                let ofntrue = "emberChangeBoolean(this,'"+path+"','true','"+data.numericPath+"')";
                linktrue.setAttribute("onclick", ofntrue);
                dvo.append(linktrue);

                let linkfalse = document.createElement("A");
                linkfalse.classList.add("tree-option");
                linkfalse.textContent = "false";
                let ofnfalse = "emberChangeBoolean(this,'"+path+"','false','"+data.numericPath+"')";
                linkfalse.setAttribute("onclick", ofnfalse);
                dvo.append(linkfalse);
            }
            li.appendChild(dvo);
        } else {
            let dvo = document.createElement("DIV");
            dvo.classList.add("tree-options");
            let dvlink = document.createElement("SPAN");
            dvlink.classList.add("tree-option--non-writable");
            dvlink.textContent = "change";
            dvo.append(dvlink);
            li.appendChild(dvo);
        }

        return li;
    }

    function treeIdFromStringPath(path) {
        return path.split("/").join("").toLowerCase().replace(" ", "");
    }

    function emberChangeString(element, path, value, numericPath) {
        let change = window.prompt(`Change string`, value);
        if (change !== null) {
            connection.invoke("ChangeEmberStringParameter", numericPath, change).catch((err) => {
                return console.error("Could not send change", err);
            });
        }
    }

    function emberChangeNumber(element, path, value, numericPath) {
        let change = window.prompt(`Change number`, value);
        if (change !== null) {
            connection.invoke("ChangeEmberNumberParameter", numericPath, parseInt(change)).catch((err) => {
                return console.error("Could not send change", err);
            });
        }
    }

    function emberChangeBoolean(element, path, value, numericPath) {
        let state = value == "true" ? true : false;
        connection.invoke("ChangeEmberBooleanParameter", numericPath, state ).catch((err) => {
            return console.error("Could not send change", err);
        });
    }

    /* Custom Event */
    class UserFeedbackEvent {
        identifier = null;
        active = false;
        error = undefined;
        timer = undefined;

        constructor(identifier, active, error, timer) {
            this.identifier = identifier || null;
            this.active = active;
            this.error = error;
            this.timer = timer;
        }

        getMessage = () => {
            let message = { detail: {} };
            message.detail[this.identifier] = {};
            if (typeof this.active !== "undefined") {
                message.detail[this.identifier].active = this.active;
            };
            if (typeof this.error !== "undefined") {
                message.detail[this.identifier].error = this.error;
            };
            if (typeof this.timer !== "undefined") {
                message.detail[this.identifier].timer = this.timer;
            };
            return message;
        }

        create = (eventName) => {
            return new CustomEvent(eventName, this.getMessage());
        }
    }

    window.addEventListener("embertree_changed",
        function(event) {
            if (!event) return;
            let e = event.detail;
            console.log("Received event:", e);
        });

    window.dispatchEvent( new UserFeedbackEvent("EmbertreeChanged", true, "Wooppie", 6000).create("embertree_changed") );

</script>
</body>
</html>